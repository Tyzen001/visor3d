<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Visor 3D Interactivo</title>
  <style>
    :root {
      --bg-color: #000000; --text-color: #ffffff; --canvas-bg: #1a1a1a;
      --slider-track: #444; --slider-thumb: #ffffff; --control-bg: rgba(25, 25, 25, 0.4);
      --control-border: #444;
    }
    .light-theme {
      --bg-color: #f0f0f0; --text-color: #000000; --canvas-bg: #ffffff;
      --slider-track: #ccc; --slider-thumb: #333; --control-bg: rgba(255, 255, 255, 0.4);
      --control-border: #ddd;
    }
    html, body {
      height: 100%; width: 100%; margin: 0; overflow: hidden;
      background-color: var(--bg-color); color: var(--text-color); font-family: monospace;
      display: flex; justify-content: center; align-items: center;
    }
    .visor-container {
      width: 100%; height: 100%; display: flex;
      justify-content: center; align-items: center; position: relative;
    }
    canvas {
      max-width: 100%; max-height: 100%; width: auto; height: auto;
      object-fit: contain; cursor: grab;
    }
    canvas:active { cursor: grabbing; }
    .controls-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%;
      padding: 20px 40px; box-sizing: border-box; background: var(--control-bg);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      display: flex; flex-direction: column; gap: 15px;
    }
    .control-individual { display: flex; align-items: center; gap: 15px; }
    .control-individual label { width: 80px; }
    input[type="range"] {
      -webkit-appearance: none; appearance: none; width: 100%; height: 4px;
      background: var(--slider-track); border-radius: 2px; outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
      background: var(--slider-thumb); border-radius: 50%; cursor: pointer; border: 2px solid var(--slider-track);
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; background: var(--slider-thumb);
      border-radius: 50%; cursor: pointer; border: 2px solid var(--slider-track);
    }
    .top-controls {
      position: absolute; top: 20px; left: 20px; right: 20px;
      display: flex; justify-content: space-between; align-items: center; z-index: 10;
    }
    .icon-button {
      background: var(--control-bg); backdrop-filter: blur(10px); border: 1px solid var(--control-border);
      border-radius: 50%; width: 40px; height: 40px; cursor: pointer;
      display: flex; justify-content: center; align-items: center; color: var(--text-color);
      text-decoration: none; font-size: 1.5em;
    }
    .loading-text { position: absolute; font-size: 1.5em; text-align: center; }
  </style>
</head>
<body>

  <div class="visor-container">
    <p class="loading-text" id="loading-text">Iniciando...</p>
    <canvas id="visor-canvas"></canvas>
    <div class="top-controls">
        <a href="index.html" class="icon-button" title="Volver al Catálogo">←</a>
        <button id="theme-toggle" class="icon-button" title="Cambiar Tema">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
    </div>
    <div class="controls-overlay">
      <div class="control-individual"><label for="horizontal-slider">Horizontal:</label><input type="range" min="0" value="0" id="horizontal-slider"></div>
      <div class="control-individual"><label for="vertical-slider">Vertical:</label><input type="range" min="0" value="0" id="vertical-slider"></div>
    </div>
  </div>

  <script>
    // --- LÓGICA DE CARGA DINÁMICA - SIN LÍMITES ---
    const urlParams = new URLSearchParams(window.location.search);
    const nombreProducto = urlParams.get('producto') || 'producto_1';
    const extensionesPosibles = ['.jpeg', '.jpg', '.png', '.webp'];

    const canvas = document.getElementById('visor-canvas'), ctx = canvas.getContext('2d');
    const sliderH = document.getElementById('horizontal-slider'), sliderV = document.getElementById('vertical-slider');
    const loadingText = document.getElementById('loading-text');

    let imagenesH = [], imagenesV = [];
    let imagenActivaX = 0, imagenActivaY = 0;

    // Función robusta para cargar una imagen probando extensiones
    function cargarUnaImagen(rutaBase, nombreFrame) {
        return new Promise(resolve => {
            const img = new Image();
            let extIndex = 0;
            function probarSiguiente() {
                if (extIndex >= extensionesPosibles.length) {
                    resolve(null); // No se encontró ninguna imagen con las extensiones dadas
                    return;
                }
                img.src = `${rutaBase}${nombreFrame}${extensionesPosibles[extIndex]}`;
                extIndex++;
            }
            img.onload = () => resolve(img);
            img.onerror = probarSiguiente;
            probarSiguiente();
        });
    }
    
    // Función que carga TODAS las imágenes en una carpeta hasta que no encuentra más
    async function cargarSecuenciaCompleta(rutaBase) {
        const secuencia = [];
        let i = 1;
        while (true) {
            const nombreFrame = `frame-${i.toString().padStart(5, '0')}`;
            const imagen = await cargarUnaImagen(rutaBase, nombreFrame);
            if (imagen) {
                secuencia.push(imagen);
                loadingText.textContent = `Cargando '${nombreProducto}': ${secuencia.length} imágenes...`;
                i++;
            } else {
                break; // Se detiene el bucle cuando ya no se encuentran más imágenes
            }
        }
        return secuencia;
    }

    async function initialize() {
        imagenesH = await cargarSecuenciaCompleta(`images/${nombreProducto}/horizontal/`);
        imagenesV = await cargarSecuenciaCompleta(`images/${nombreProducto}/vertical/`);

        if (imagenesH.length === 0 && imagenesV.length === 0) {
            loadingText.textContent = `Error: No se encontraron imágenes para '${nombreProducto}'.`;
            return;
        }
        loadingText.style.display = 'none';
        iniciarVisor();
    }
    
    function iniciarVisor() {
        const primeraImagen = imagenesH[0] || imagenesV[0];
        if (!primeraImagen) return;

        canvas.width = primeraImagen.naturalWidth;
        canvas.height = primeraImagen.naturalHeight;
        
        // El máximo del slider ahora es el número de imágenes encontradas menos uno
        sliderH.max = imagenesH.length > 1 ? imagenesH.length - 1 : 0;
        sliderV.max = imagenesV.length > 1 ? imagenesV.length - 1 : 0;

        let arrastrando = false, inicioX, inicioY;
        const sensibilidad = 2;
        
        function dibujarImagen(img) {
            if (img && img.complete) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
        
        dibujarImagen(primeraImagen);

        sliderH.addEventListener('input', e => { imagenActivaX = parseInt(e.target.value); dibujarImagen(imagenesH[imagenActivaX]); });
        sliderV.addEventListener('input', e => { imagenActivaY = parseInt(e.target.value); dibujarImagen(imagenesV[imagenActivaY]); });
        
        canvas.addEventListener('mousedown', e => { arrastrando = true; inicioX = e.clientX; inicioY = e.clientY; canvas.style.cursor = 'grabbing'; });
        canvas.addEventListener('mouseup', () => { arrastrando = false; canvas.style.cursor = 'grab'; });
        canvas.addEventListener('mouseleave', () => { arrastrando = false; canvas.style.cursor = 'grab'; });

        canvas.addEventListener('mousemove', e => {
            if (!arrastrando) return;
            const deltaX = e.clientX - inicioX, deltaY = e.clientY - inicioY;
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (imagenesH.length < 2) return;
                const cambio = Math.floor(deltaX / (canvas.clientWidth / (imagenesH.length / sensibilidad)));
                let nuevoIndex = imagenActivaX + cambio;
                imagenActivaX = Math.max(0, Math.min(imagenesH.length - 1, nuevoIndex));
                sliderH.value = imagenActivaX;
                requestAnimationFrame(() => dibujarImagen(imagenesH[imagenActivaX]));
            } else {
                if (imagenesV.length < 2) return;
                const cambio = Math.floor(deltaY / (canvas.clientHeight / (imagenesV.length / sensibilidad)));
                let nuevoIndex = imagenActivaY - cambio;
                imagenActivaY = Math.max(0, Math.min(imagenesV.length - 1, nuevoIndex));
                sliderV.value = imagenActivaY;
                requestAnimationFrame(() => dibujarImagen(imagenesV[imagenActivaY]));
            }
        });
    }

    const themeToggle = document.getElementById('theme-toggle');
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'light') document.body.classList.add('light-theme');
    
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('light-theme');
        localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
    });

    initialize();
  </script>
</body>
</html>